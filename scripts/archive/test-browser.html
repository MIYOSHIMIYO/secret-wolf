<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§˜å¯†äººç‹¼ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background-color: #45a049;
        }
        .test-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background-color: #f8f9fa;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ® ç§˜å¯†äººç‹¼ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆ1: çŸ¥ã‚Šåˆã„ã¨éŠã¶ - ãƒ«ãƒ¼ãƒ ä½œæˆ</h2>
        <p>ã€ŒçŸ¥ã‚Šåˆã„ã¨éŠã¶ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ«ãƒ¼ãƒ ä½œæˆç”»é¢ã«é·ç§»ã—ã€å³åº§ã«ãƒ«ãƒ¼ãƒ å¾…æ©Ÿã‚·ãƒ¼ãƒ³ã«ç§»è¡Œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testRoomCreation()">ãƒ«ãƒ¼ãƒ ä½œæˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="room-creation-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆ2: è§£æ•£æ©Ÿèƒ½</h2>
        <p>ãƒ«ãƒ¼ãƒ å¾…æ©Ÿç”»é¢ã§è§£æ•£ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å³åº§ã«è§£æ•£ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚·ãƒ¼ãƒ³ã«ç§»è¡Œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testDisband()">è§£æ•£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="disband-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆ3: çŸ¥ã‚‰ãªã„èª°ã‹ã¨ - ãƒãƒƒãƒãƒ³ã‚°</h2>
        <p>ã€ŒçŸ¥ã‚‰ãªã„èª°ã‹ã¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒãƒƒãƒãƒ³ã‚°ã‚·ãƒ¼ãƒ³ã§è‡ªèº«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã«é©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testAutoMatching()">ãƒãƒƒãƒãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="auto-matching-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆ4: ç¹°ã‚Šè¿”ã—å®Ÿè¡Œ</h2>
        <p>ä¸Šè¨˜ã®ãƒ†ã‚¹ãƒˆã‚’è¤‡æ•°å›å®Ÿè¡Œã—ã¦ã€å•é¡ŒãŒç™ºç”Ÿã—ãªã„ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testRepeatedExecution()">ç¹°ã‚Šè¿”ã—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="repeated-result"></div>
    </div>
    
    <div class="test-section">
        <h2>å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <p>å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="all-tests-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h2>
        <div id="test-log" class="log"></div>
        <button class="test-button" onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <script>
        let testResults = {
            roomCreation: null,
            disband: null,
            autoMatching: null,
            repeated: null
        };
        
        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        
        async function testRoomCreation() {
            log('=== ãƒ†ã‚¹ãƒˆ1: ãƒ«ãƒ¼ãƒ ä½œæˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            showResult('room-creation-result', 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            
            try {
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«ç§»å‹•
                if (window.location.pathname !== '/menu' && window.location.pathname !== '/') {
                    window.location.href = '/menu';
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                // çŸ¥ã‚Šåˆã„ã¨éŠã¶ãƒœã‚¿ãƒ³ã‚’æ¢ã™
                const friendsButton = document.querySelector('img[alt="çŸ¥ã‚Šåˆã„ã¨éŠã¶"]')?.closest('button');
                if (!friendsButton) {
                    throw new Error('çŸ¥ã‚Šåˆã„ã¨éŠã¶ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('çŸ¥ã‚Šåˆã„ã¨éŠã¶ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
                friendsButton.click();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // ãƒ«ãƒ¼ãƒ ä½œæˆç”»é¢ã§ä½œæˆãƒœã‚¿ãƒ³ã‚’æ¢ã™
                const createButton = Array.from(document.querySelectorAll('button')).find(btn => 
                    btn.textContent.includes('ä½œæˆ') && !btn.disabled
                );
                if (!createButton) {
                    throw new Error('ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
                const startTime = Date.now();
                createButton.click();
                
                // ãƒ«ãƒ¼ãƒ å¾…æ©Ÿç”»é¢ã«é·ç§»ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                let lobbyFound = false;
                for (let i = 0; i < 100; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (window.location.pathname.includes('/lobby/')) {
                        lobbyFound = true;
                        break;
                    }
                }
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (lobbyFound) {
                    log(`âœ… ãƒ«ãƒ¼ãƒ å¾…æ©Ÿç”»é¢ã¸ã®é·ç§»æˆåŠŸ (${duration}ms)`);
                    showResult('room-creation-result', `âœ… æˆåŠŸï¼é·ç§»æ™‚é–“: ${duration}ms`, 'success');
                    testResults.roomCreation = { success: true, duration };
                } else {
                    log('âŒ ãƒ«ãƒ¼ãƒ å¾…æ©Ÿç”»é¢ã¸ã®é·ç§»å¤±æ•—');
                    showResult('room-creation-result', 'âŒ å¤±æ•—: ãƒ«ãƒ¼ãƒ å¾…æ©Ÿç”»é¢ã¸ã®é·ç§»ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    testResults.roomCreation = { success: false };
                }
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('room-creation-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.roomCreation = { success: false, error: error.message };
            }
        }
        
        async function testDisband() {
            log('=== ãƒ†ã‚¹ãƒˆ2: è§£æ•£ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            showResult('disband-result', 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            
            try {
                // è§£æ•£ãƒœã‚¿ãƒ³ã‚’æ¢ã™
                const disbandButton = Array.from(document.querySelectorAll('button')).find(btn => 
                    btn.textContent.includes('è§£æ•£')
                );
                if (!disbandButton) {
                    throw new Error('è§£æ•£ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('è§£æ•£ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
                const startTime = Date.now();
                disbandButton.click();
                
                // è§£æ•£ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ã¯ã„ãƒœã‚¿ãƒ³ã‚’æ¢ã™
                const confirmButton = Array.from(document.querySelectorAll('button')).find(btn => 
                    btn.textContent.includes('ã¯ã„')
                );
                if (!confirmButton) {
                    throw new Error('è§£æ•£ç¢ºèªãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('è§£æ•£ç¢ºèªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
                confirmButton.click();
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                let menuFound = false;
                for (let i = 0; i < 50; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (window.location.pathname === '/menu' || window.location.pathname === '/') {
                        menuFound = true;
                        break;
                    }
                }
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (menuFound) {
                    log(`âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¸ã®é·ç§»æˆåŠŸ (${duration}ms)`);
                    showResult('disband-result', `âœ… æˆåŠŸï¼é·ç§»æ™‚é–“: ${duration}ms`, 'success');
                    testResults.disband = { success: true, duration };
                } else {
                    log('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¸ã®é·ç§»å¤±æ•—');
                    showResult('disband-result', 'âŒ å¤±æ•—: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¸ã®é·ç§»ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    testResults.disband = { success: false };
                }
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('disband-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.disband = { success: false, error: error.message };
            }
        }
        
        async function testAutoMatching() {
            log('=== ãƒ†ã‚¹ãƒˆ3: è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            showResult('auto-matching-result', 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            
            try {
                // çŸ¥ã‚‰ãªã„èª°ã‹ã¨ãƒœã‚¿ãƒ³ã‚’æ¢ã™
                const randomButton = document.querySelector('img[alt="çŸ¥ã‚‰ãªã„èª°ã‹ã¨"]')?.closest('button');
                if (!randomButton) {
                    throw new Error('çŸ¥ã‚‰ãªã„èª°ã‹ã¨ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('çŸ¥ã‚‰ãªã„èª°ã‹ã¨ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
                randomButton.click();
                
                // ãƒãƒƒãƒãƒ³ã‚°ç”»é¢ã«é·ç§»ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã‚’ç¢ºèª
                const playerList = document.querySelector('.space-y-3') || 
                                  document.querySelector('[class*="space-y-3"]');
                
                if (!playerList) {
                    throw new Error('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const players = playerList.querySelectorAll('[class*="bg-white/5"]');
                log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ (${players.length}äºº)`);
                
                // è‡ªèº«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                const hasSelf = Array.from(players).some(player => 
                    player.textContent.includes('å‚åŠ æ¸ˆã¿') || 
                    player.querySelector('.animate-pulse')
                );
                
                if (hasSelf) {
                    log('âœ… è‡ªèº«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™');
                    showResult('auto-matching-result', `âœ… æˆåŠŸï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${players.length}äºº`, 'success');
                    testResults.autoMatching = { success: true, playerCount: players.length };
                } else {
                    log('âŒ è‡ªèº«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showResult('auto-matching-result', `âŒ å¤±æ•—: è‡ªèº«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“`, 'error');
                    testResults.autoMatching = { success: false, playerCount: players.length };
                }
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('auto-matching-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.autoMatching = { success: false, error: error.message };
            }
        }
        
        async function testRepeatedExecution() {
            log('=== ãƒ†ã‚¹ãƒˆ4: ç¹°ã‚Šè¿”ã—å®Ÿè¡Œãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            showResult('repeated-result', 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            
            const results = [];
            const testCount = 3;
            
            for (let i = 1; i <= testCount; i++) {
                log(`\n--- ç¹°ã‚Šè¿”ã—ãƒ†ã‚¹ãƒˆ ${i}/${testCount} ---`);
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                if (window.location.pathname !== '/menu' && window.location.pathname !== '/') {
                    window.location.href = '/menu';
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // ãƒ«ãƒ¼ãƒ ä½œæˆãƒ†ã‚¹ãƒˆ
                const roomResult = await testRoomCreation();
                results.push({ test: 'room_creation', iteration: i, success: roomResult.success });
                
                if (roomResult.success) {
                    // è§£æ•£ãƒ†ã‚¹ãƒˆ
                    const disbandResult = await testDisband();
                    results.push({ test: 'disband', iteration: i, success: disbandResult.success });
                }
            }
            
            // çµæœã®é›†è¨ˆ
            const roomCreationSuccess = results.filter(r => r.test === 'room_creation' && r.success).length;
            const disbandSuccess = results.filter(r => r.test === 'disband' && r.success).length;
            
            log(`\n--- ç¹°ã‚Šè¿”ã—ãƒ†ã‚¹ãƒˆçµæœ ---`);
            log(`ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ: ${roomCreationSuccess}/${testCount}`);
            log(`è§£æ•£æˆåŠŸ: ${disbandSuccess}/${testCount}`);
            
            const allSuccessful = roomCreationSuccess === testCount && disbandSuccess === testCount;
            
            if (allSuccessful) {
                showResult('repeated-result', `âœ… æˆåŠŸï¼å…¨${testCount}å›ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ`, 'success');
                testResults.repeated = { success: true, roomCreationSuccess, disbandSuccess };
            } else {
                showResult('repeated-result', `âŒ å¤±æ•—: ãƒ«ãƒ¼ãƒ ä½œæˆ${roomCreationSuccess}/${testCount}, è§£æ•£${disbandSuccess}/${testCount}`, 'error');
                testResults.repeated = { success: false, roomCreationSuccess, disbandSuccess };
            }
        }
        
        async function runAllTests() {
            log('=== å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ ===');
            showResult('all-tests-result', 'å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            
            // ãƒ†ã‚¹ãƒˆ1: ãƒ«ãƒ¼ãƒ ä½œæˆ
            await testRoomCreation();
            
            // ãƒ†ã‚¹ãƒˆ2: è§£æ•£ï¼ˆãƒ«ãƒ¼ãƒ ä½œæˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ï¼‰
            if (testResults.roomCreation?.success) {
                await testDisband();
            }
            
            // ãƒ†ã‚¹ãƒˆ3: è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°
            await testAutoMatching();
            
            // ãƒ†ã‚¹ãƒˆ4: ç¹°ã‚Šè¿”ã—å®Ÿè¡Œ
            await testRepeatedExecution();
            
            // çµæœã‚µãƒãƒªãƒ¼
            const summary = `
                <h3>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h3>
                <p>1. ãƒ«ãƒ¼ãƒ ä½œæˆ: ${testResults.roomCreation?.success ? 'âœ…' : 'âŒ'} ${testResults.roomCreation?.duration ? `(${testResults.roomCreation.duration}ms)` : ''}</p>
                <p>2. è§£æ•£: ${testResults.disband?.success ? 'âœ…' : 'âŒ'} ${testResults.disband?.duration ? `(${testResults.disband.duration}ms)` : ''}</p>
                <p>3. è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°: ${testResults.autoMatching?.success ? 'âœ…' : 'âŒ'} ${testResults.autoMatching?.playerCount ? `(${testResults.autoMatching.playerCount}äºº)` : ''}</p>
                <p>4. ç¹°ã‚Šè¿”ã—å®Ÿè¡Œ: ${testResults.repeated?.success ? 'âœ…' : 'âŒ'}</p>
            `;
            
            showResult('all-tests-result', summary, 'info');
            log('=== å…¨ãƒ†ã‚¹ãƒˆå®Œäº† ===');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            log('ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            log('å„ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        });
    </script>
</body>
</html>
