# 技術仕様変更書 - ウェブブラウザ配布移行

## 1. 概要

本ドキュメントは、秘密人狼ゲームをストア配布からウェブブラウザ配布に移行する際の技術仕様変更をまとめたものです。コードの詳細な実装ではなく、設計思想と技術的アプローチの変更点を中心に記述します。

## 2. アーキテクチャの変更

### 2.1 現在のアーキテクチャ
```
[ユーザー] → [ストアアプリ] → [Capacitor] → [WebView] → [React App] → [Cloudflare Workers]
```

### 2.2 移行後のアーキテクチャ
```
[ユーザー] → [Webブラウザ] → [React App] → [Cloudflare Workers]
```

**変更の意図**: 中間レイヤー（Capacitor + WebView）を排除し、直接的なブラウザ-サーバー通信を実現することで、パフォーマンス向上と複雑性の削減を図る。

## 3. フロントエンド技術スタックの調整

### 3.1 維持する技術
- **React 18**: 既存のコンポーネント設計をそのまま活用
- **TypeScript**: 型安全性を維持
- **Tailwind CSS**: スタイリングシステムを維持
- **Vite**: ビルドツールを維持

### 3.2 追加する技術
- **PWA機能**: Service Worker、Web App Manifest
- **レスポンシブデザイン**: より幅広いデバイス対応
- **ブラウザAPI**: 通知、オフライン対応等

### 3.3 削除する技術
- **Capacitor**: ネイティブアプリ化のためのフレームワーク
- **ネイティブプラグイン**: カメラ、ファイルシステム等のネイティブ機能

**変更の意図**: ウェブ標準技術に集中することで、メンテナンス性と互換性を向上させる。

## 4. 通信プロトコルの調整

### 4.1 WebSocket通信の最適化
- **現在**: Capacitor WebView内でのWebSocket通信
- **変更後**: ブラウザネイティブWebSocket通信

**最適化ポイント**:
- 接続確立時間の短縮
- メモリ使用量の削減
- エラーハンドリングの簡素化

### 4.2 CORS設定の調整
- **現在**: `capacitor://localhost` のみ許可
- **変更後**: ウェブドメインを許可リストに追加

**セキュリティ考慮**:
- 本番環境では特定ドメインのみ許可
- 開発環境では柔軟な設定を維持

## 5. 状態管理の調整

### 5.1 セッション管理
- **現在**: Capacitor Preferences + メモリ
- **変更後**: LocalStorage + SessionStorage + メモリ

**変更の意図**: ブラウザ標準のストレージAPIを使用することで、より予測可能な動作を実現。

### 5.2 データ永続化
- **現在**: ネイティブアプリの永続ストレージ
- **変更後**: ブラウザのLocalStorage

**考慮事項**: ブラウザのデータクリア機能により、ユーザーが完全にデータを削除可能。

## 6. 課金システムの変更

### 6.1 現在のシステム
- **RevenueCat**: ストア連携による課金管理
- **ストア決済**: App Store、Google Playの決済システム

### 6.2 移行後のシステム
- **Stripe/PayPal**: ウェブ決済システム
- **直接決済**: ストアを経由しない決済

**技術的メリット**:
- ストア手数料（30%）の排除
- より柔軟な価格設定
- 国際的な決済対応の向上

## 7. 広告システムの変更

### 7.1 現在のシステム
- **AdMob**: モバイルアプリ専用広告
- **ネイティブ統合**: Capacitorプラグイン経由

### 7.2 移行後のシステム
- **Google AdSense**: ウェブ広告システム
- **直接統合**: JavaScript SDK経由

**技術的メリット**:
- より広範なデバイスでの表示
- 設定の簡素化
- パフォーマンスの向上

## 8. セキュリティ対策の強化

### 8.1 通信セキュリティ
- **HTTPS強制**: すべての通信を暗号化
- **HSTS**: 強制的なHTTPS接続
- **CSP**: Content Security PolicyによるXSS防止

### 8.2 データ保護
- **入力検証**: クライアント・サーバー両方での検証
- **XSS対策**: 出力エスケープの徹底
- **CSRF対策**: トークンベースの保護

### 8.3 既存機能の維持
- **自動モデレーション**: 既存の通報・フィルタリング機能を維持
- **レート制限**: IP単位でのアクセス制限を維持
- **データ最小化**: 収集データの最小化を維持

## 9. パフォーマンス最適化

### 9.1 読み込み時間の短縮
- **コード分割**: 必要な機能のみを読み込み
- **遅延読み込み**: 非同期でのリソース読み込み
- **キャッシュ最適化**: ブラウザキャッシュの活用

### 9.2 実行時パフォーマンス
- **メモリ使用量**: WebViewオーバーヘッドの排除
- **CPU使用量**: ネイティブ機能のオーバーヘッド排除
- **ネットワーク効率**: 直接通信による効率化

## 10. ユーザビリティの向上

### 10.1 アクセシビリティ
- **キーボード操作**: キーボードのみでの操作対応
- **スクリーンリーダー**: 音声読み上げ対応
- **色のコントラスト**: 視認性の向上

### 10.2 レスポンシブデザイン
- **モバイルファースト**: スマートフォンでの最適化
- **タブレット対応**: 中サイズデバイスでの最適化
- **デスクトップ対応**: 大画面での最適化

## 11. 開発・運用の簡素化

### 11.1 開発プロセス
- **ビルド時間**: Capacitorビルドの排除による短縮
- **テスト環境**: ブラウザでの直接テスト
- **デバッグ**: ブラウザ開発者ツールの活用

### 11.2 デプロイメント
- **即座の更新**: サーバー側の更新で全ユーザーに反映
- **A/Bテスト**: より簡単な機能テスト
- **ロールバック**: 迅速な問題対応

## 12. 監視・ログの調整

### 12.1 パフォーマンス監視
- **Web Vitals**: Core Web Vitalsの監視
- **リアルユーザーモニタリング**: 実際のユーザー体験の監視
- **エラー追跡**: ブラウザエラーの追跡

### 12.2 セキュリティ監視
- **アクセスログ**: 異常なアクセスパターンの検出
- **セキュリティイベント**: 攻撃の検出と対応
- **コンプライアンス**: プライバシー規制への対応

## 13. 将来の拡張性

### 13.1 技術的拡張性
- **モジュラー設計**: 機能の追加・削除が容易
- **API設計**: 外部連携のためのAPI提供
- **マイクロサービス**: 必要に応じたサービス分離

### 13.2 ビジネス拡張性
- **多言語対応**: 国際展開への対応
- **エンタープライズ機能**: 企業向け機能の追加
- **パートナー連携**: 他サービスとの連携

## 14. 移行時の考慮事項

### 14.1 データ移行
- **既存ユーザー**: 新システムへの移行手順
- **設定データ**: ユーザー設定の移行
- **履歴データ**: 必要に応じた履歴保持

### 14.2 段階的移行
- **ベータ版**: 限定ユーザーでのテスト
- **段階的リリース**: 機能ごとの段階的公開
- **フィードバック収集**: ユーザー意見の収集と反映

## 15. 成功指標

### 15.1 技術指標
- **パフォーマンス**: 読み込み時間、応答時間の改善
- **安定性**: エラー率の削減、稼働率の向上
- **セキュリティ**: セキュリティインシデントの防止

### 15.2 ビジネス指標
- **ユーザー体験**: ユーザー満足度の向上
- **開発効率**: 開発・運用コストの削減
- **収益性**: 収益機会の拡大

---

**この技術仕様変更により、より効率的で持続可能な技術基盤を構築し、ユーザーに優れた体験を提供できるようになります。**
