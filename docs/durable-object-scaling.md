# Durable Object スケール設計

## 1. 現状の分析

### 1.1 現在の実装
- 単一のDurable Object（RoomDO）で全ルームを管理
- 各ルームは最大8人まで対応
- 同時接続数：50ユーザー（Phase 0検証結果）

### 1.2 問題点
- 単一DOがボトルネックになる可能性
- スケール時のコスト予測が困難
- ルーム間の分離が不十分

## 2. スケール設計案

### 2.1 ルーム分割戦略
```
現在: 1つのDO → 全ルーム
提案: ルームごとに個別のDO
```

**メリット:**
- ルーム間の独立性確保
- 並列処理による性能向上
- 個別のスケール制御

**デメリット:**
- DO数の増加によるコスト上昇
- 管理の複雑化

### 2.2 接続数制限の実装
```typescript
// ルームごとの接続数制限
const MAX_CONNECTIONS_PER_ROOM = 8;
const MAX_ACTIVE_ROOMS = 100; // 同時アクティブルーム数
const MAX_TOTAL_CONNECTIONS = 800; // 全体の接続数制限
```

### 2.3 キューイング戦略
```typescript
// 接続数制限時のキューイング
interface ConnectionQueue {
  roomId: string;
  waitingUsers: Array<{
    installId: string;
    nick: string;
    timestamp: number;
  }>;
}
```

## 3. コスト試算

### 3.1 Cloudflare Workers 料金
- **Request数**: 1,000,000リクエスト/月 = $0.50
- **CPU時間**: 10,000,000 GB-秒/月 = $12.50
- **Durable Objects**: 1,000,000 リクエスト/月 = $0.50

### 3.2 想定シナリオ
```
同時接続数: 50ユーザー
アクティブルーム数: 10ルーム
1日あたりのセッション数: 500セッション
1セッションあたりの平均時間: 30分
```

**月間コスト試算:**
- リクエスト数: ~1,500,000 = $0.75
- CPU時間: ~5,000,000 GB-秒 = $6.25
- Durable Objects: ~1,500,000 = $0.75
- **合計: ~$7.75/月**

### 3.3 スケール時のコスト
```
同時接続数: 200ユーザー
アクティブルーム数: 40ルーム
1日あたりのセッション数: 2,000セッション
```

**月間コスト試算:**
- リクエスト数: ~6,000,000 = $3.00
- CPU時間: ~20,000,000 GB-秒 = $25.00
- Durable Objects: ~6,000,000 = $3.00
- **合計: ~$31.00/月**

## 4. 実装計画

### 4.1 Phase 1: 基本実装
- 現在の単一DO構成を維持
- 接続数制限の実装
- モニタリングの追加

### 4.2 Phase 2: ルーム分割
- ルームごとの個別DO実装
- ルーム管理システムの構築
- 負荷分散の実装

### 4.3 Phase 3: 高度な最適化
- キューイングシステムの実装
- 動的スケーリング
- コスト最適化

## 5. 監視指標

### 5.1 パフォーマンス指標
- 接続確立時間
- メッセージ遅延
- 同時接続数
- ルーム作成/削除時間

### 5.2 コスト指標
- リクエスト数/時間
- CPU使用時間
- DO使用数
- 月間コスト

### 5.3 アラート設定
- 接続数が制限の80%に達した場合
- 月間コストが予算の80%に達した場合
- エラー率が5%を超えた場合

## 6. 推奨事項

### 6.1 短期（Phase 1）
- 現在の構成で接続数制限を実装
- 詳細なモニタリングを開始
- コスト追跡システムを構築

### 6.2 中期（Phase 2）
- ルーム分割の実装
- 負荷分散の最適化
- 自動スケーリングの検討

### 6.3 長期（Phase 3）
- マイクロサービス化の検討
- マルチリージョン対応
- 高度な最適化

## 7. リスク管理

### 7.1 技術的リスク
- DO数の増加による管理複雑化
- 分散システムの一貫性問題
- パフォーマンスの劣化

### 7.2 コストリスク
- 予期しないコスト増加
- スケール時のコスト爆発
- リソースの無駄遣い

### 7.3 対応策
- 段階的な実装
- 詳細なモニタリング
- コストアラートの設定
- 定期的な見直し

---

**作成日**: 2024年12月
**バージョン**: 1.0
**承認者**: プロジェクト責任者
