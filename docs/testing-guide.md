# テストガイド

## 📋 概要
このドキュメントは、秘密人狼ゲームのテスト戦略と実行方法を説明します。

## 🧪 テストの種類

### 1. 単体テスト
- **目的**: 個別の関数やコンポーネントの動作確認
- **実行方法**: `pnpm test`
- **対象**: ユーティリティ関数、Reactコンポーネント

### 2. 統合テスト
- **目的**: 複数のコンポーネントやサービス間の連携確認
- **実行方法**: `node scripts/test-runner.js`
- **対象**: WebSocket通信、API連携、ゲームフロー

### 3. ネットワークテスト
- **目的**: 通信の安定性とパフォーマンス確認
- **実行方法**: `node scripts/network-audit.js [dev|prod]`
- **対象**: HTTP接続、WebSocket接続、レイテンシ

### 4. エンドツーエンドテスト
- **目的**: ユーザー視点での完全な動作確認
- **実行方法**: `node scripts/test-runner.js`
- **対象**: ゲーム開始から終了までの全フロー

## 🚀 テスト実行方法

### 開発環境でのテスト
```bash
# すべてのテストを実行
pnpm test:all

# ネットワークテストのみ
node scripts/network-audit.js dev

# 特定のテストのみ
node scripts/test-runner.js "ネットワーク監査"
```

### 本番環境でのテスト
```bash
# 本番環境のネットワークテスト
node scripts/network-audit.js prod

# 完全なゲームフローテスト
node test-complete-game-flow.js
```

### CI/CDでのテスト
```bash
# CI用テストスクリプト
./scripts/ci-test.sh
```

## 📊 テスト結果の解釈

### 成功基準
- **ネットワークテスト**: 成功率 > 95%
- **統合テスト**: 成功率 > 90%
- **クリティカルテスト**: 成功率 = 100%

### パフォーマンス基準
- **HTTP接続**: レイテンシ < 1000ms
- **WebSocket接続**: 接続時間 < 2000ms
- **メッセージ往復**: RTT < 100ms

## 🔧 テスト環境の設定

### 開発環境
```bash
# サーバー起動
pnpm -C packages/worker dev

# クライアント起動
pnpm -C packages/client dev
```

### 本番環境
```bash
# 本番デプロイ
pnpm -C packages/worker wrangler publish --env prod

# クライアントビルド
pnpm -C packages/client build:production
```

## 🐛 トラブルシューティング

### よくある問題

#### 1. WebSocket接続エラー
```bash
# 接続診断
node scripts/diagnose-connection.js

# ポート確認
lsof -i :8787
lsof -i :5173
```

#### 2. テストタイムアウト
- ネットワークの状態を確認
- サーバーの負荷を確認
- タイムアウト設定を調整

#### 3. 依存関係エラー
```bash
# 依存関係再インストール
pnpm install --force

# キャッシュクリア
pnpm store prune
```

## 📈 テストメトリクス

### 監視項目
- テスト成功率
- 実行時間
- エラー率
- パフォーマンス指標

### レポート
- テスト結果は `test-results/` ディレクトリに保存
- CI/CDでは GitHub Actions のアーティファクトとして保存

## 🔄 継続的テスト

### 自動実行
- **プッシュ時**: すべてのテストを実行
- **プルリクエスト時**: 変更に関連するテストを実行
- **スケジュール**: 毎日午前2時（JST 11時）に実行

### 手動実行
```bash
# 特定のテストを実行
node scripts/test-runner.js "ゲームフロー全体"

# 本番環境のテスト
node scripts/network-audit.js prod
```

## 📝 テストケース

### 基本機能
- [ ] ルーム作成・参加
- [ ] プレイヤー接続・切断
- [ ] ゲームフロー進行
- [ ] チャット機能
- [ ] 投票機能

### エラーハンドリング
- [ ] ネットワーク切断時の再接続
- [ ] サーバーエラー時の適切なメッセージ表示
- [ ] レート制限時の動作
- [ ] 不正な入力の処理

### パフォーマンス
- [ ] 同時接続数
- [ ] メッセージ処理速度
- [ ] メモリ使用量
- [ ] レスポンス時間

## 🎯 テスト戦略

### 段階的テスト
1. **単体テスト**: 個別機能の確認
2. **統合テスト**: 機能間の連携確認
3. **システムテスト**: 全体システムの確認
4. **受け入れテスト**: ユーザー要件の確認

### テストデータ
- テスト用のルームID: `TEST01`
- テスト用のプレイヤー名: `テストプレイヤー`
- テスト用の秘密: `これはテスト用の秘密です`

## 📞 サポート

### 問題報告
- GitHub Issues で問題を報告
- テスト結果とログを添付
- 再現手順を明記

### 連絡先
- 開発者: [連絡先]
- テスト担当: [連絡先]

---

## 🔗 関連リンク
- [テストランナー](scripts/test-runner.js)
- [ネットワーク監査](scripts/network-audit.js)
- [CI/CD設定](.github/workflows/test.yml)
- [デプロイチェックリスト](deployment-checklist.md)
